# Excel Export Feature

## Overview
This feature allows downloading SalesForce case data as an Excel file. The implementation downloads CSV results from AWS S3 (generated by Athena queries) and converts them to Excel format.

## Architecture

### Components

1. **S3Service** - Downloads CSV files from AWS S3
   - Interface: [`S3Service.java`](src/main/java/com/performance/metrics/services/S3Service.java)
   - Implementation: [`S3ServiceImpl.java`](src/main/java/com/performance/metrics/services/impl/S3ServiceImpl.java)

2. **ExcelService** - Converts CSV to Excel format
   - Interface: [`ExcelService.java`](src/main/java/com/performance/metrics/services/ExcelService.java)
   - Implementation: [`ExcelServiceImpl.java`](src/main/java/com/performance/metrics/services/impl/ExcelServiceImpl.java)

3. **MetricsService** - Orchestrates the query execution and Excel generation
   - Interface: [`MetricsService.java`](src/main/java/com/performance/metrics/services/MetricsService.java)
   - Implementation: [`MetricsServiceImpl.java`](src/main/java/com/performance/metrics/services/impl/MetricsServiceImpl.java)

4. **MetricsController** - REST API endpoint
   - Controller: [`MetricsController.java`](src/main/java/com/performance/metrics/controllers/MetricsController.java)

## Flow

1. Client sends POST request to `/public/metrics/getSalesForceDataAsExcel`
2. MetricsService executes Athena query via MCP client
3. Extract query execution ID from the response's `resource_link` (format: `athena://query-execution-id`)
4. S3Service downloads CSV from S3 bucket using the query execution ID
   - S3 path: `s3://aws-athena-query-results-219341907983-ap-south-1/{query-execution-id}.csv`
5. ExcelService converts CSV to Excel with formatting
6. Controller returns Excel file as downloadable attachment

## API Endpoint

### Download Excel File

**Endpoint:** `POST /public/metrics/getSalesForceDataAsExcel`

**Headers:**
```
x-workspace-id: <workspace-id>
Content-Type: application/json
```

**Request Body:**
```json
{
  "case_record_type__c": ["B2B Enterprise", "Notice Management"],
  "customer_segment__c": ["B2B - CA/SME"],
  "type": ["Feature"]
}
```

**Response:**
- Content-Type: `application/octet-stream`
- Content-Disposition: `attachment; filename="salesforce_data.xlsx"`
- Body: Excel file binary data

**Example cURL:**
```bash
curl -X POST "http://localhost:8080/public/metrics/getSalesForceDataAsExcel" \
  -H "x-workspace-id: your-workspace-id" \
  -H "Content-Type: application/json" \
  -d '{
    "case_record_type__c": ["B2B Enterprise"],
    "customer_segment__c": ["B2B - CA/SME"],
    "type": ["Feature"]
  }' \
  --output salesforce_data.xlsx
```

## Configuration

### Application Properties

Add the following to [`application.properties`](src/main/resources/application.properties):

```properties
# AWS S3 Configuration
aws.s3.bucket.name=aws-athena-query-results-219341907983-ap-south-1
aws.region=ap-south-1
aws.access.key.id=${AWS_ACCESS_KEY_ID:}
aws.secret.access.key=${AWS_SECRET_ACCESS_KEY:}
```

### AWS Credentials

The application supports two methods for AWS authentication:

1. **Environment Variables** (Recommended for production):
   ```bash
   export AWS_ACCESS_KEY_ID=your-access-key
   export AWS_SECRET_ACCESS_KEY=your-secret-key
   ```

2. **Default Credentials Chain** (For local development):
   - AWS credentials file (`~/.aws/credentials`)
   - IAM role (when running on EC2/ECS)
   - Environment variables

## Dependencies

The following dependencies were added to [`pom.xml`](pom.xml):

```xml
<!-- AWS S3 SDK -->
<dependency>
    <groupId>software.amazon.awssdk</groupId>
    <artifactId>s3</artifactId>
    <version>2.20.26</version>
</dependency>

<!-- Apache POI for Excel -->
<dependency>
    <groupId>org.apache.poi</groupId>
    <artifactId>poi-ooxml</artifactId>
    <version>5.2.5</version>
</dependency>

<!-- Apache Commons CSV -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-csv</artifactId>
    <version>1.10.0</version>
</dependency>
```

## Excel Features

The generated Excel file includes:

- **Header Row**: Bold font, grey background, borders
- **Data Rows**: Bordered cells with proper formatting
- **Auto-sized Columns**: Columns are automatically sized for readability
- **All Query Results**: Complete dataset from S3 (not limited to preview rows)

## Error Handling

The implementation includes comprehensive error handling:

- S3 download failures
- CSV parsing errors
- Excel conversion issues
- Missing query execution ID

All errors are logged and return appropriate HTTP status codes.

## SQL Query Fix

The table name quoting was fixed from single quotes to double quotes:
- **Before**: `salesforce_crm_v2.'case'`
- **After**: `salesforce_crm_v2."case"`

This is required because "case" is a SQL reserved keyword and must be quoted with double quotes for identifiers.

## Testing

To test the implementation:

1. Ensure AWS credentials are configured
2. Start the application
3. Send a POST request to the Excel endpoint
4. Verify the downloaded Excel file contains the expected data

## Notes

- The S3 bucket name and region are configurable via properties
- The implementation uses streaming to handle large CSV files efficiently
- Excel files are generated in-memory and returned directly to the client
- The query execution ID is extracted from the Athena MCP response's `resource_link` field
